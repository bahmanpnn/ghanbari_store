# FROM python:latest
FROM python:alpine

ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
ENV DJANGO_SUPERUSER_PASSWORD admin

RUN mkdir /app
WORKDIR /app
COPY ./requirements.txt .

# for installing mysqlclient it needs to mariadb-dev and for installing,it needs to 3 package
# because python image is alpine and its os is debian we need use apk not apt like ubuntu
RUN apk update
RUN apk add --no-cache gcc python3-dev musl-dev mariadb-dev

RUN pip install --upgrade pip
# RUN pip install "pip<=24.1"
RUN pip install mysqlclient
RUN pip install -r requirements.txt

# after installing mariadb-dev we can manage memory and uninstall 3 packages that installed for mariadb-dv
RUN apk del gcc python3-dev musl-dev


CMD while ! python3 manage.py sqlflush > /dev/null 2>&1 ; do sleep 1 ; done && \
    python3 manage.py makemigrations --noinput && \
    python3 manage.py migrate --noinput && \
    python3 manage.py collectstatic --noinput && \
    python3 manage.py createsuperuser --user admin --email admin@localhost --noinput || true ; \
    gunicorn -b 0.0.0.0:8000 ghanbari_store.wsgi:application





# # FROM python:3.11-alpine
# FROM python:alpine


# ENV PYTHONDONTWRITEBYTECODE 1
# ENV PYTHONUNBUFFERED 1
# ENV DJANGO_SUPERUSER_PASSWORD admin

# RUN mkdir /app
# WORKDIR /app
# COPY ./requirements.txt .

# # for installing mysqlclient it needs to mariadb-dev and for installing,it needs to 3 package
# # because python image is alpine and its os is debian we need use apk not apt like ubuntu
# RUN apk update
# RUN apk add --no-cache gcc python3-dev musl-dev mariadb-dev
# # RUN apk add --no-cache gcc musl-dev python3-dev mariadb-dev build-base py3-setuptools py3-pip

# RUN pip install --upgrade pip
# # RUN pip install "pip<=24.1"
# RUN pip install -r requirements.txt

# # after installing mariadb-dev we can manage memory and uninstall 3 packages that installed for mariadb-dv
# RUN apk del gcc python3-dev musl-dev


# COPY entrypoint.sh /entrypoint.sh
# RUN chmod +x /entrypoint.sh
# ENTRYPOINT ["/entrypoint.sh"]


# CMD while ! python3 manage.py sqlflush > /dev/null 2>&1 ; do sleep 1 ; done && \
#     python3 manage.py makemigrations --noinput && \
#     python3 manage.py migrate --noinput && \
#     python3 manage.py collectstatic --noinput && \
#     python3 manage.py createsuperuser --user admin --email admin@localhost --noinput || true ; \
#     gunicorn -b 0.0.0.0:8000 ghanbari_store.wsgi:application







