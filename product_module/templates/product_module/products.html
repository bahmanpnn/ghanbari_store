{% extends "base.html" %}
{% load static %}
{% load poll_extras %}


{% block header_references %}
    <link rel="stylesheet" href="{% static "product_module/css/product_custom.css" %}">
    <link rel="stylesheet" href="{% static "product_module/css/product_fast_review.css" %}">
{% endblock header_references %}
{% block content %}

    <!-- rts navigation bar area start -->
    <div class="rts-navigation-area-breadcrumb">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="navigator-breadcrumb-wrapper">
                        <a href="{% url "home_module:home-page" %}">صفحه اصلی</a>
                        <i class="fa-regular fa-chevron-left"></i>
                        <a class="current">فروشگاه</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- rts navigation bar area end -->
    <div class="section-seperator">
        <div class="container">
            <hr class="section-seperator">
        </div>
    </div>

    <!-- shop[ grid sidebar wrapper -->
    <div class="shop-grid-sidebar-area rts-section-gap">
        <div class="container">
            <div class="row g-0">
                <div class="col-xl-12 col-lg-12">
                    <div class="filter-select-area">
                        <div class="nice-select-area-wrapper-and-button">
                            <div class="nice-select-wrapper-1">
                                <div class="single-select">
                                    <form method="get" action="" id='filter-form' novalidate>
                                        <div>
                                            {{filter_form}}
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="myTabContent">
                        <div class="product-area-wrapper-shopgrid-list mt--20 tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                            <div class="row g-4 swiper-wrapper">
                                {% for product in products %}
                                    <div class="col-lg-20 col-lg-4 col-md-6 col-sm-12 col-12">
                                        {% include "product_module/includes/product_item.html" with product=product %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="product-area-wrapper-shopgrid-list with-list mt--20 tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="single-shopping-card-one discount-offer">
                                        <a href="shop-details.html" class="thumbnail-preview">
                                            <div class="badge">
                                                <span>25% <br> 
                                                    تخفیف
                                                </span>
                                                <i class="fa-solid fa-bookmark"></i>
                                            </div>
                                            <img src="/static/assets/images/grocery/03.jpg" alt="خواربار">
                                        </a>
                                        <div class="body-content">
                                            <div class="title-area-right">
                                                <a href="shop-details.html">
                                                    <h4 class="title">میوه های مخلوط و گندم کاجیب سرلاک با شیر</h4>
                                                </a>
                                                <span class="availability">بسته 500 گرمی</span>
                                                <div class="price-area">
                                                    <span class="current">36.00 تومان</span>
                                                    <div class="previous">36.00 تومان</div>
                                                </div>
                                                <div class="cart-counter-action">
                                                    <div class="quantity-edit">
                                                        <input type="text" class="input" value="1">
                                                        <div class="button-wrapper-action">
                                                            <button class="button"><i class="fa-regular fa-chevron-down"></i></button>
                                                            <button class="button plus">+<i class="fa-regular fa-chevron-up"></i></button>
                                                        </div>
                                                    </div>
                                                    <a href="#" class="rts-btn btn-primary radious-sm with-icon">
                                                        <div class="btn-text">
                                                            افزودن به سبد خرید
                                                        </div>
                                                        <div class="arrow-icon">
                                                            <i class="fa-regular fa-cart-shopping"></i>
                                                        </div>
                                                        <div class="arrow-icon">
                                                            <i class="fa-regular fa-cart-shopping"></i>
                                                        </div>
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="natural-value">
                                                <h6 class="title">
                                                    ارزش های تغذیه ای
                                                </h6>
                                                <div class="single">
                                                    <span>انرژی (کیلو کالری): </span>
                                                    <span>211</span>
                                                </div>
                                                <div class="single">
                                                    <span>پروتئین (g): </span>
                                                    <span>211</span>
                                                </div>
                                                <div class="single">
                                                    <span>مگنتیم (کیلو کالری): </span>
                                                    <span>211</span>
                                                </div>
                                                <div class="single">
                                                    <span>کالری (کیلو کالری): </span>
                                                    <span>211</span>
                                                </div>
                                                <div class="single">
                                                    <span>ویتامین (کیلو کالری): </span>
                                                    <span>211</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- shop[ grid sidebar wrapper end -->
    
    
    <!-- pagination -->

    <div class="pagination">
        <ul class="pagination post-pagination">
            {% if page_obj.has_previous %}
                <li>
                    <a class="prev btn rts-btn" href="?{% query_update request page=page_obj.previous_page_number %}">
                        قبلی
                    </a>
                </li>
            {% endif %}
    
            {% for page in paginator.page_range %}
                <li>
                    <a 
                        {% if page_obj.number == page %}
                            class="btn rts-btn active"
                        {% else %}
                            class="btn rts-btn"
                        {% endif %}
                        href="?{% query_update request page=page %}"
                    >
                        {{ page }}
                    </a>
                </li>
            {% endfor %}
    
            {% if page_obj.has_next %}
                <li>
                    <a class="next btn rts-btn" href="?{% query_update request page=page_obj.next_page_number %}">
                        بعدی
                    </a>
                </li>
            {% endif %}
        </ul>
    </div>
    
    <!-- end pagination -->

    <!-- fast review modal-->
        {% include "product_module/includes/product_modal.html" %}
    <!-- end fast review modal-->
     
{% endblock content %}
{% block footer_references %}
    <script>
        $(document).ready(function () {          
            // Function to reset the modal content
            function resetModalContent() {
                $(".product-title").text(""); // Clear the title
                $("#modalProductCount").val(1);
                $(".product-thumb").css("background-image", ""); // Clear the background image
                $(".product-thumb img").attr("src", ""); // Clear the main image
                $(".product-price").html(""); // Clear the price
                $(".contents p").text(""); // Clear the description
                $(".stock").text(""); // Clear the stock status
                $(".rating-stars-group").empty(); 
                $(".product-thumb-filter-group").empty(); 
                //$(".rating-stars-group").html(""); // Clear the stars
                //$(".product-thumb-filter-group").html(""); // Clear the thumbnails
            }
        
            // Delegate click event to dynamically added elements
            $(".swiper-wrapper").on("click", ".product-details-popup-btn", function (event) {
                event.preventDefault(); // Prevent default behavior
        
                // Reset the modal content
                resetModalContent();
        
                // Extract product details from data attributes
                const title = $(this).data("title");
                const productId = $(this).data("product-id");
                const image = $(this).data("image");
                const weight = $(this).data("product-weight");
                const price = $(this).data("price");
                const oldPrice = $(this).data("old-price");
                const description = $(this).data("description");
                const stock = $(this).data("stock");
                const rating = $(this).data("rating");
                const extraImages = $(this).data("extra-images");

                // Dynamically set the unique ID for the input field
                let quantityInputId = `modalProductCount_${productId}`;
                $("#modalProductCount").attr("id", quantityInputId);  // Change ID dynamically

                $(".add-to-basket-btn").data("product-id", productId);
                $(".add-to-basket-btn").data("quantity-id", quantityInputId); // Store quantity input

                // Price Handling: Check if price and oldPrice are valid
                let priceHTML = "";
                if (price && price !== "None") {
                    priceHTML = `<span class="old-price">${oldPrice} تومان</span> ${price} تومان`;
                }else {
                    priceHTML=`<span>${oldPrice} تومان</span>`
                }

                let stockSpan = document.querySelector(".stock");
                if (stock){
                    if (stock == "ناموجود") {
                        stockSpan.classList.add("out-of-stock","alert","alert-danger","text-danger");
                    } else {
                        stockSpan.classList.remove("out-of-stock","alert","alert-danger","text-danger");
                    }
                }

                // Set the product ID in the onclick attribute of the Add to Basket button
                //$(".add-to-basket-btn").attr("onclick", `addModalProductToBasket(${productId})`);
                

                // Update modal content with new data
                $(".product-title").text(title);
                $(".product-thumb").css("background-image", `url(${image})`);
                $(".product-thumb img").attr("src", image);
                $(".product-price").html(priceHTML);
                $(".stock").text(stock);
                if (weight && weight !== "None") {
                    $(".product-weight").text(product-weight);
                }
                $(".product-id").text(productId);
                $(".contents p").text(description);
        
                // Add stars based on rating
                for (let i = 0; i < 5; i++) {
                    if (i < rating) {
                        $(".rating-stars-group").append('<div class="rating-star"><i class="fas fa-star"></i></div>');
                    } else {
                        $(".rating-stars-group").append('<div class="rating-star"><i class="far fa-star"></i></div>');
                    }
                }
        
                // Update thumbnails
                const thumbnailsContainer = $(".product-thumb-filter-group");
                thumbnailsContainer.append(`
                    <div class="thumb-filter filter-btn active" data-show=".one">
                        <img src="${image}" alt="Main Product Image" />
                    </div>
                `);
        
                // Show modal
                $(".product-details-popup-wrapper").fadeIn();
                console.log("Button clicked:", $(this).data("title"));
            });

            $(document).on("click", ".add-to-basket-btn", function () {
                let productId = $(this).data("product-id");
                addModalProductToBasket(productId);
            });

        
            // Close modal
            $(".product-details-close-btn").click(function () {
                $(".product-details-popup-wrapper").fadeOut();
            });
        });
    </script>   
    <script>
        function updateSorting() {
            const form = document.getElementById('filter-form');
            const sortSelect = document.getElementById('sort');
            const selectedSort = sortSelect.value;

            // Create a URLSearchParams object to manage query parameters
            const params = new URLSearchParams(new FormData(form));

            // Update the sort parameter
            params.set('product_filter', selectedSort);

            // Redirect to the updated URL
            window.location.search = params.toString();
        }
    </script>
{% endblock footer_references %}

$(document).on("click", ".add-to-basket-btn", function () {
    var productId = $(this).data("product-id");
    addModalProductToBasket(productId);
});
